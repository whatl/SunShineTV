# 部署脚本使用说明

## 📁 文件结构

```
scripts/deploy/
├── build.sh                 # 主构建脚本（执行这个）
├── build-docker.sh         # Docker 构建脚本
├── .env.docker.example     # 环境变量模板
├── docker-compose.yml      # Docker Compose 配置
├── docker-deploy.sh        # 服务器部署脚本
└── README.md              # 部署说明文档
```

## 🚀 使用步骤

### 1. 本地构建部署包

在项目根目录执行：

```bash
cd scripts/deploy
./build.sh
```

构建完成后会在 `output/` 目录生成：
- `sunshinetv-docker-YYYYMMDD-HHMMSS.zip` - 部署包
- `deploy-docker-YYYYMMDD-HHMMSS/` - 解压后的目录

### 2. 上传到服务器

```bash
# 上传部署包
scp output/sunshinetv-docker-*.zip user@server:/path/to/deploy/
```

### 3. 服务器部署

```bash
# 登录服务器
ssh user@server

# 解压
unzip sunshinetv-docker-*.zip
cd deploy-docker-*/

# 配置环境变量
cp .env.example .env
vi .env  # 修改配置

# 启动服务
./docker-deploy.sh start
```

### 4. 验证部署

访问：http://服务器IP:3000

查看日志：
```bash
./docker-deploy.sh logs
```

## 🔧 服务管理命令

```bash
./docker-deploy.sh start    # 启动服务
./docker-deploy.sh stop     # 停止服务
./docker-deploy.sh restart  # 重启服务
./docker-deploy.sh logs     # 查看日志
./docker-deploy.sh rebuild  # 重新构建
./docker-deploy.sh status   # 查看状态
```

## 📋 环境变量配置

必须修改的配置项（在 .env 文件中）：

```env
# 管理员账号
USERNAME=admin
PASSWORD=修改为强密码

# 站点名称
NEXT_PUBLIC_SITE_NAME=你的站点名称

# 存储配置（使用 Kvrocks）
NEXT_PUBLIC_STORAGE_TYPE=redis
REDIS_HOST=kvrocks
REDIS_PORT=6666
```

## 🐳 服务说明

部署后会启动两个容器：

1. **sunshinetv** - 主应用
   - 端口：3000
   - 健康检查：http://localhost:3000/api/health

2. **sunshinetv-kvrocks** - 数据存储
   - 端口：6666
   - 数据持久化：Docker Volume

## 💾 数据备份与恢复

### 备份数据

```bash
docker run --rm \
  -v sunshinetv_kvrocks-data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/kvrocks-backup.tar.gz -C /data .
```

### 恢复数据

```bash
docker run --rm \
  -v sunshinetv_kvrocks-data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/kvrocks-backup.tar.gz -C /data
```

## ❓ 常见问题

### 端口被占用

修改 `docker-compose.yml`：
```yaml
services:
  app:
    ports:
      - "8080:3000"  # 改成其他端口
```

### 查看详细日志

```bash
docker-compose logs -f app
docker-compose logs -f kvrocks
```

### 完全重新部署

```bash
# 停止并删除所有数据
docker-compose down -v

# 重新启动
docker-compose up -d
```
